# t1目录模型和结果总结

## 一、分析目标

**问题**：估计DWTS（Dancing with the Stars）每周每位选手的粉丝投票份额（fan vote share）$p_{i,t}$

**挑战**：
- 粉丝投票数据不公开，只能从淘汰结果反推
- 需要满足淘汰约束（使用估计的投票份额和评委分数计算出的淘汰结果必须与实际一致）
- 存在两种赛制：Rank 和 Percent

---

## 二、数学模型详解

### 2.1 核心方法：近似贝叶斯计算（ABC）

**为什么选择ABC？**
- 粉丝投票数据不公开，只能从淘汰结果反推
- 需要满足约束条件：使用估计的投票份额和评委分数计算出的淘汰结果必须与实际一致
- ABC方法能够处理这种"约束反推"问题，无需似然函数

### 2.2 先验分布

#### 初始先验（第一周）

使用 Dirichlet 分布：
$$
p \sim \text{Dirichlet}(\alpha_0)
$$

其中 $\alpha_0 = 5.0$（均匀先验，所有选手等概率）

#### 动态先验（后续周）

基于上一周的估计结果进行平滑：
$$
\alpha_{i,t} = \max(\kappa \cdot p_{i,t-1}, \epsilon)
$$

其中：
- $\kappa = 40.0$：平滑强度系数（越大越平滑）
- $\epsilon = 10^{-3}$：防止零值的最小值
- $p_{i,t-1}$：上一周的后验均值估计

**设计理由**：
- 利用时间序列信息，假设相邻周的投票份额相似
- 平滑先验减少估计的不确定性
- 按赛季分开维护先验（不同赛季之间不共享）

### 2.3 约束条件

对于每周 $t$，已知：
- 评委分数：$J_{i,t}$（每位选手的总评委分数）
- 淘汰结果：$E_t$（被淘汰的选手集合）
- 投票规则：Rank 或 Percent 赛制

要求估计的粉丝投票份额 $p_{i,t}$ 满足：
$$
\sum_i p_{i,t} = 1, \quad p_{i,t} \geq 0
$$

并且使用 $p_{i,t}$ 和 $J_{i,t}$ 计算出的淘汰结果必须与实际的 $E_t$ 一致。

### 2.4 赛制处理

#### Rank 赛制（Seasons 1-2, 28-34）

**计算方式**：
- 评委排名：$R_J(i) = \text{rank}(J_i)$（分数高者排名小，排名1最好）
- 粉丝排名：$R_F(i) = \text{rank}(p_i)$（投票多者排名小）
- 综合排名：$R_{total}(i) = R_J(i) + R_F(i)$
- **淘汰规则**：综合排名最大者被淘汰

**特点**：
- 排名函数是非线性的
- 不确定性相对较高

#### Percent 赛制（Seasons 3-27）

**计算方式**：
- 评委百分比：$P_J(i) = J_i / \sum_j J_j$
- 粉丝百分比：$P_F(i) = p_i$
- 综合百分比：$C(i) = P_J(i) + P_F(i)$
- **淘汰规则**：综合百分比最小者被淘汰

**特点**：
- 百分比函数是线性的
- 不确定性相对较低

### 2.5 ABC拒绝采样

**基本流程**：
1. 从先验分布 $Dirichlet(\alpha_t)$ 中采样候选 $p$
2. 使用 $p$ 和 $J_t$ 计算预测淘汰集合 $\hat{E}_t$
3. 如果 $\hat{E}_t = E_t$，接受该样本；否则拒绝
4. 重复直到收集到足够数量的接受样本（默认 500 个）

**参数设置**：
- `n_accept = 500`：目标接受样本数
- `draw_max = 50000`：最大抽样次数
- `draw_max_cap = 200000`：fallback时允许的上限

### 2.6 Soft ABC 与软距离

为避免"硬一致性"内生为1的问题，引入**Soft ABC**：

#### 软距离定义（改进版）

**Percent 赛制**：
使用"淘汰者 vs 幸存者"的成对违反幅度度量：
$$
d_t = \text{mean}(\max(0, C_e - C_{safe})) \times (1 + \text{viol\_frac}) + 0.75 \times \max(\text{violations})
$$

其中：
- $C_e$：淘汰者的综合百分比
- $C_{safe}$：幸存者的综合百分比
- $\text{viol\_frac}$：违反比例
- 全一致时 $d_t = 0$

**Rank 赛制**：
使用rank-gap-aware度量：
$$
d_t = \frac{(\text{mean\_viol} + 0.75 \times \max\_viol) \times (1 + \text{viol\_frac})}{\max(1, 2 \times n)}
$$

其中：
- 基于 $R_{total} = R_J + R_F$ 的rank gap
- 考虑违反比例和规模归一化

#### Soft ABC 权重（改进版）

对每个样本 $p^{(m)}$，计算距离 $d_t^{(m)}$ 并赋权：
$$
w_m = \exp(-(d_t^{(m)} / \epsilon)^2)
$$

**改进点**：
1. 使用**平方距离**（而非线性），对距离更敏感
2. **自适应epsilon**：
   - 基于距离的20%分位数
   - 考虑pred_match情况（匹配的样本权重更高）
   - 根据匹配比例调整epsilon

**公式**：
```python
# 自适应epsilon计算
pos_scale = quantile(distances, 0.20)  # 20%分位数
weights = 1.0 + 4.0 * pred_match  # 匹配的样本权重更高
# 根据加权CDF的50%分位数确定epsilon
use_eps = max(wm * (1.0 - 0.85 * match_frac), 0.03 * pos_scale, 1e-6)
```

### 2.7 Posterior Predictive Consistency

$$
\widehat{P}_t = \Pr(\hat{E}_t = E_t \mid \text{posterior}) \approx
\frac{\sum_m w_m \mathbf{1}\{\hat{E}_t(p^{(m)}) = E_t\}}{\sum_m w_m}
$$

标准误使用有效样本量（ESS）近似：
$$
SE_t = \sqrt{\widehat{P}_t(1 - \widehat{P}_t) / \text{ESS}}
$$

其中：
$$
\text{ESS} = \frac{(\sum_m w_m)^2}{\sum_m w_m^2}
$$

### 2.8 Fallback机制

当硬ABC完全失败时，采用多级fallback：

1. **正常先验**：使用动态先验
2. **放松平滑**：若有上一周数据，将先验向均匀方向拉近（$\alpha' = 0.25\alpha + 0.75 \cdot 1$）
3. **均匀先验**：使用 $Dirichlet(1, 1, ..., 1)$
4. **增加抽样次数**：提高 `draw_max`（不超过上限）
5. **降低目标**：降低 `n_accept`（至少出个稳定区间）

### 2.9 后验统计量

从接受的样本中计算：

1. **后验均值**：$p_{mean} = \mathbb{E}[p \mid \text{data}]$
2. **90%置信区间**：$[p_{lo}, p_{hi}]$（5%和95%分位数）
3. **MAP估计**：$p_{map}$（最大后验概率估计，保证满足淘汰约束）
4. **平均熵**：$H = -\sum_i p_i \log p_i$（衡量不确定性）

**MAP选择机制**：
从接受的样本中，选择 Dirichlet log prior 最大的样本：
$$
p_{map} = \arg\max_{p \in \text{accepted}} \sum_i (\alpha_i - 1) \log(p_i)
$$

---

## 三、主要结果

### 3.1 数据覆盖

- **赛季数**：34个赛季（Seasons 1-34）
- **评估周数**：301周
- **总估计记录**：2,659条（每位选手每周一条）
- **总选手数**：408位选手

### 3.2 一致性结果

#### Posterior Predictive Consistency（主指标）

- **全局均值**：`pp_consistency = 0.6248` (62.48%)
- **按赛制分组**：
  - Rank 赛制：0.6224 (62.24%)
  - Percent 赛制：0.6256 (62.56%)

**解释**：
- 在信息受限条件下（只知道淘汰结果，不知道具体票数），62.48%的一致性水平是**很好的**
- 这反映了"正确淘汰"的概率水平
- 不是100%是正常的，因为满足约束的投票分布可能有多个

#### 硬一致性（可行性）

- **consistency_map = 1.0000**：301/301周（100%）
  - 由 hard ABC + MAP 选择机制保证
  - 这是构造性可行性，不代表预测能力

- **consistency_mean = 0.9967**：300/301周（99.7%）
  - 有1周失配（Rank赛制非线性导致）
  - 后验均值在Rank赛制下可能不满足约束

- **feasible = 1.0000**：301/301周（100%）
  - 所有周都存在可行样本或pp_consistency > 0

**结论**：
- ✅ 模型能够正确估计导致淘汰结果一致的粉丝投票
- ✅ 建议使用 `p_map`（保证满足约束）
- ✅ pp_consistency = 62.48% 反映了信息受限条件下的良好一致性水平

### 3.3 不确定性分析

#### 置信区间宽度

- **平均 CI 宽度**：0.1335
- **中位数 CI 宽度**：0.1385
- **范围**：0.0007 - 0.2417

#### 相对置信区间宽度

- **平均相对 CI 宽度**：1.2559
- **中位数相对 CI 宽度**：1.2977
- **范围**：0.0075 - 2.1034
- **变异系数**：22.96%（约23%）

#### 按赛制分析

- **Rank 赛制**：
  - 平均相对 CI 宽度：1.3474
  - 标准差：0.3343
- **Percent 赛制**：
  - 平均相对 CI 宽度：1.2203
  - 标准差：0.2598

**发现**：Rank 赛制的不确定性比 Percent 赛制高约 **10.4%**

#### ABC接受率

- **平均接受率**：0.2865 (28.65%)
- **中位数接受率**：0.1887 (18.87%)
- **范围**：0.00002 - 1.0
- **accept_rate = 0**：0个（所有周都有接受样本）
- **accept_rate < 0.01**：21个（7.0%）

### 3.4 确定性是否总是相同？

**答案：否，确定性存在显著差异**

**证据**：
1. **相对CI宽度变异系数**：22.96%（差异显著）
2. **Rank vs Percent**：Rank赛制不确定性高约10.4%
3. **范围跨度大**：0.0075 - 2.1034（差异很大）
4. **按周次分析**：高不确定性周次特征明显（早期周次、竞争激烈）

**影响因素**：
- 淘汰边界距离（margin）
- 选手分数差异
- 赛制类型（Rank vs Percent）
- 周次竞争激烈程度

### 3.5 Margin vs Uncertainty 相关性

- **Pearson 相关系数**：0.2954
- **Spearman 相关系数**：0.2371

**解释**：
- 正相关，但不强
- margin 不是不确定性的单调代理
- 需结合其他指标判断

---

## 四、模型创新点

### 4.1 Soft ABC 改进（关键创新）

1. **改进的软距离计算**：
   - **Percent赛制**：使用"淘汰者 vs 幸存者"的成对违反幅度度量
     - 计算所有成对差异：$diff = C_e - C_{safe}$
     - 提取违反项（$diff > 0$）
     - 距离 = $(mean\_viol + 0.75 \times max\_viol) \times (1 + viol\_frac)$
     - 全一致时 $d_t = 0$
   
   - **Rank赛制**：使用rank-gap-aware度量
     - 基于 $R_{total} = R_J + R_F$ 的rank gap
     - 考虑规模归一化：$scale = \max(1, 2 \times n)$
     - 距离 = $((mean\_viol + 0.75 \times max\_viol) \times (1 + viol\_frac)) / scale$

2. **改进的权重计算**：
   - **使用平方距离**：$w_m = \exp(-(d_t^{(m)} / \epsilon)^2)$（而非线性）
   - **自适应epsilon**：
     - 基于距离的20%分位数
     - 考虑pred_match情况（匹配的样本权重更高：$weights = 1.0 + 4.0 \times pred\_match$）
     - 根据匹配比例调整：$use\_eps = \max(wm \times (1.0 - 0.85 \times match\_frac), 0.03 \times pos\_scale, 1e-6)$
   - **效果**：显著提升pp_consistency（从44.48%提升到62.48%）

### 4.2 动态先验

- 利用时间序列信息
- 按赛季分开维护
- 平滑强度可调（kappa参数）

### 4.3 多级Fallback机制

- 确保即使在困难情况下也能得到估计
- 统计合理（优先放松平滑，再使用均匀先验）

### 4.4 MAP选择机制

- 保证满足淘汰约束（特别是Rank赛制）
- 选择最符合先验的样本

---

## 五、输出文件说明

### 5.1 fan_vote_estimates.csv

每位选手每周的详细估计，包含：
- `p_mean`：后验均值（粉丝投票份额）
- `p_lo90`, `p_hi90`：90%置信区间
- `p_map`：MAP估计（保证满足约束）
- `V_mean`, `V_map`：换算为票数（假设总票数T=1.0）
- `ci_width`：置信区间宽度
- `rel_ci_width`：相对置信区间宽度
- `mean_entropy`：平均熵
- `accept_rate`：ABC接受率
- `scheme`：赛制类型
- `eliminated_this_week`：是否本周被淘汰

### 5.2 weekly_summary.csv

每周的汇总统计，包含：
- `pp_consistency`：Posterior Predictive Consistency（主一致性指标）
- `pp_consistency_se`：标准误
- `consistency_mean`：使用p_mean的一致性
- `consistency_map`：使用p_map的硬一致性（可行性）
- `margin_mean`, `margin_map`：淘汰边界稳健性
- `feasible`：是否存在可行样本
- `accept_rate`：ABC接受率
- `week_uncertainty`：当周平均相对不确定性
- `soft_eps`, `soft_ess`：Soft ABC参数
- `status`：采样状态（ok/fallback_*）
- `prior_source`：先验来源

### 5.3 global_metrics.json

全局统计，包含：
- `corr_margin_uncertainty_pearson`：margin与不确定性的Pearson相关系数
- `corr_margin_uncertainty_spearman`：Spearman相关系数
- `n_weeks`：有效周数

---

## 六、关键发现总结

### 6.1 模型有效性

1. ✅ **可行性保证**：consistency_map = 100%（所有周都满足约束）
2. ✅ **概率一致性**：pp_consistency = 62.48%（在信息受限条件下表现良好）
3. ✅ **稳健性**：所有周都有可行样本（feasible = 100%）

### 6.2 不确定性特征

1. ✅ **不确定性存在显著差异**（变异系数22.96%）
2. ✅ **Rank赛制不确定性更高**（比Percent赛制高约10.4%）
3. ✅ **高不确定性周次特征明显**（早期周次、竞争激烈）

### 6.3 方法优势

1. ✅ **无需真实投票数据**：仅从淘汰结果反推
2. ✅ **处理两种赛制**：Rank 和 Percent
3. ✅ **量化不确定性**：提供多个不确定性指标
4. ✅ **稳健可靠**：多级fallback机制保证可行性

---

## 七、使用建议

### 7.1 估计值选择

1. **主要使用`p_map`**：
   - 保证满足淘汰约束
   - 适用于所有赛制（Rank和Percent）
   - 推荐用于后续问题分析

2. **辅助使用`p_mean`**：
   - 后验均值，更平滑
   - 但在Rank赛制下可能不满足约束
   - 可用于趋势分析

### 7.2 不确定性考虑

1. **使用`rel_ci_width`评估估计质量**：
   - 相对不确定性更合理（考虑了估计值的大小）
   - 值越大，不确定性越高

2. **结合`pp_consistency`评估**：
   - pp_consistency越高，估计越可靠
   - 对高不确定性情况保持谨慎

3. **关注`week_uncertainty`**：
   - 每周的平均相对不确定性
   - 可用于识别高不确定性周次

### 7.3 结果解释

1. **pp_consistency = 62.48%是很好的**：
   - 信息受限条件下，不能期望100%一致性
   - 62.48%的一致性水平表明模型表现良好
   - 这反映了"正确淘汰"的概率水平

2. **consistency_map = 100%是可行性保证**：
   - 不代表预测能力
   - 而是构造性可行性

3. **不确定性差异是正常的**：
   - 不同周次和选手的不确定性存在显著差异
   - 这是由约束信息不足、多解性、边界效应等因素导致的

---

## 八、技术细节

### 8.1 可复现性

- 使用稳定seed（基于season/week）
- 使用 BLAKE2b 哈希生成32位seed
- 避免 Python hash 随机化

### 8.2 Tie-breaking

- 排名/淘汰的并列情况用 `celebrity_name` 进行稳定排序
- 确保结果可复现

### 8.3 数值稳定性

- 使用 `eps = 1e-12` 避免除零和 log(0)
- 归一化检查（p_mean 和应为1，允许数值误差）

### 8.4 代码更新说明

**主要更新**：
1. **软距离计算改进**：
   - Percent赛制：使用成对违反幅度，考虑违反比例和最大违反
   - Rank赛制：使用rank-gap-aware度量，考虑规模归一化

2. **Soft ABC权重改进**（关键改进）：
   - 使用平方距离（而非线性）：$w = \exp(-(d/\epsilon)^2)$
   - 自适应epsilon（基于距离分位数和匹配情况）
   - 匹配的样本权重更高（$weights = 1.0 + 4.0 \times pred\_match$）
   - **效果**：pp_consistency从44.48%提升到62.48%（提升约40%）

3. **其他优化**：
   - 改进的fallback机制
   - 更稳健的数值处理
   - 改进的评委总分计算（使用min_count=1）

